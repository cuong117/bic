{"8fd9463dad8d2232c1e947403ead465d6a3e5f73":{"changes":{"src\/test\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/ser\/TestBinaryStreamToXMLSerialization.java":"ADD","src\/test\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/failing\/ListDeser294Test.java":"MODIFY","release-notes\/VERSION-2.x":"MODIFY","src\/main\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/ser\/ToXmlGenerator.java":"MODIFY","src\/test\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/deser\/builder\/BuilderSimpleTest.java":"MODIFY"},"diff":{"src\/test\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/ser\/TestBinaryStreamToXMLSerialization.java":[{"add":[],"delete":[]}],"src\/test\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/failing\/ListDeser294Test.java":[{"add":[],"delete":["4","import com.fasterxml.jackson.annotation.JsonProperty;"]}],"release-notes\/VERSION-2.x":[{"add":["6","2.9.8 (not yet released)","7","","8","#270: Add support for `writeBinary()` with `InputStream` to `ToXMLGenerator`","9"," (requested by csbxvs@github; contributed by marc-christian-schulze@github)","10",""],"delete":[]}],"src\/main\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/ser\/ToXmlGenerator.java":[{"add":["842","    @Override","843","    public int writeBinary(Base64Variant b64variant, InputStream data, int dataLength) throws IOException","844","    {","845","        if (data == null) {","846","            writeNull();","847","            return 0;","848","        }","849","        _verifyValueWrite(\"write Binary value\");","850","        if (_nextName == null) {","851","            handleMissingName();","852","        }","853","        try {","854","            if (_nextIsAttribute) {","855","                \/\/ Stax2 API only has 'full buffer' write method:","856","                byte[] fullBuffer = toFullBuffer(data, dataLength);","857","                _xmlWriter.writeBinaryAttribute(\"\", _nextName.getNamespaceURI(), _nextName.getLocalPart(), fullBuffer);","858","            } else if (checkNextIsUnwrapped()) {","859","              \/\/ should we consider pretty-printing or not?","860","                writeStreamAsBinary(data, dataLength);","861","","862","            } else {","863","                if (_xmlPrettyPrinter != null) {","864","                    _xmlPrettyPrinter.writeLeafElement(_xmlWriter,","865","                            _nextName.getNamespaceURI(), _nextName.getLocalPart(),","866","                            toFullBuffer(data, dataLength), 0, dataLength);","867","                } else {","868","                    _xmlWriter.writeStartElement(_nextName.getNamespaceURI(), _nextName.getLocalPart());","869","                    writeStreamAsBinary(data, dataLength);","870","                    _xmlWriter.writeEndElement();","871","                }","872","            }","873","        } catch (XMLStreamException e) {","874","            StaxUtil.throwAsGenerationException(e, this);","875","        }","876","","877","        return dataLength;","878","    }","879","","880","    private void writeStreamAsBinary(InputStream data, int len) throws IOException, XMLStreamException ","881","    {","882","        \/\/ base64 encodes up to 3 bytes into a 4 bytes string","883","        byte[] tmp = new byte[3];","884","        int offset = 0;","885","        int read;","886","        while((read = data.read(tmp, offset, Math.min(3 - offset, len))) != -1) {","887","            offset += read;","888","            len -= read;","889","            if(offset == 3) {","890","                offset = 0;","891","                _xmlWriter.writeBinary(tmp, 0, 3);","892","            }","893","            if (len == 0) {","894","                break;","895","            }","896","        }","897","","898","        \/\/ we still have < 3 bytes in the buffer","899","        if(offset > 0) {","900","            _xmlWriter.writeBinary(tmp, 0, offset);","901","        }","902","    }","903","","904","    ","917","","918","    private byte[] toFullBuffer(InputStream data, final int len) throws IOException ","919","    {","920","        byte[] result = new byte[len];","921","        int offset = 0;","922","","923","        for (; offset < len; ) {","924","            int count = data.read(result, offset, len - offset);","925","            if (count < 0) {","926","                _reportError(\"Too few bytes available: missing \"+(len - offset)+\" bytes (out of \"+len+\")\");","927","            }","928","            offset += count;","929","        }","930","        return result;","931","    }","932",""],"delete":["854","    "]}],"src\/test\/java\/com\/fasterxml\/jackson\/dataformat\/xml\/deser\/builder\/BuilderSimpleTest.java":[{"add":[],"delete":["2","import java.util.*;","3",""]}]}}}